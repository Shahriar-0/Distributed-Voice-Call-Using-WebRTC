# Project Report: WebRTC Class

## Overview

The `WebRTC` class encapsulates functionality for setting up and managing WebRTC peer-to-peer (P2P) connections using the `libdatachannel` library. Designed for real-time audio data exchange, this class handles the generation and exchange of Session Description Protocol (SDP) offers and answers, as well as the transmission of audio data through RTP (Real-time Transport Protocol) packets. The class includes functionality for managing connections, configuring media tracks, and handling network candidates for establishing reliable P2P connections.

## Attributes

### Key Attributes

- **`m_peerConnections`**: `QMap<QString, std::shared_ptr<rtc::PeerConnection>>`
  - Stores `PeerConnection` objects for each peer, indexed by `peerId`. Each `PeerConnection` manages signaling and data transmission with a particular peer.

- **`m_peerTracks`**: `QMap<QString, std::shared_ptr<rtc::Track>>`
  - Stores `Track` objects for each peer, representing the media (audio) track that is transmitted over the P2P connection.

- **`m_audio`**: `rtc::Description::Audio`
  - Defines the audio stream configuration, including track name and the intended direction (`SendRecv`), which allows bi-directional audio streaming.

- **`m_ssrc`**: `rtc::SSRC`
  - Synchronization Source Identifier (SSRC) for RTP packets, used to uniquely identify the source of each media stream.

- **`m_isOfferer`**: `bool`
  - Indicates whether the instance initiates the WebRTC connection (offerer) or responds to an offer (answerer).

### Other Key Properties

- **`m_bitRate`**: `int`
  - Bitrate for the audio stream, defaulting to 48,000 bps.
- **`m_payloadType`**: `int`
  - Specifies the payload type for RTP packets, with 111 set as the default.
- **`m_config`**: `rtc::Configuration`
  - Stores ICE server configuration, including STUN and TURN servers for NAT traversal.

---

## Methods

### Constructor and Destructor

#### `WebRTC(QObject* parent = nullptr)`

- **Description**: Initializes the `WebRTC` object, setting up the SDP generation process for local descriptions and connecting signals for SDP readiness.
- **Code Explanation**:
  - Connects the `gatheringComplited` signal to a lambda function that stores the local SDP generated by the `PeerConnection`.
  - Emits either `offerIsReady` or `answerIsReady` signals based on the `m_isOfferer` flag to indicate that the local SDP is complete.

#### `~WebRTC()`

- **Description**: Default destructor that ensures proper cleanup.

---

### Initialization and Peer Management

#### `void init(const QString& id, bool isOfferer = false)`

- **Description**: Configures the WebRTC instance with the given `id` and initializes ICE server configuration.
- **Code Explanation**:
  - Sets `m_isOfferer` and `m_localId` with the provided parameters.
  - Configures `rtc::Configuration` by adding a STUN server (`stun:stun.l.google.com:19302`) to assist with NAT traversal. Additional TURN servers could be configured for more robust connections in restricted networks.

#### `void addPeer(const QString& peerId)`

- **Description**: Creates a new `PeerConnection` for the specified peer ID and establishes callbacks for state changes, ICE candidates, and track handling.
- **Code Explanation**:
  - Creates a `PeerConnection` object and stores it in `m_peerConnections` mapped to `peerId`.
  - Sets up:
    - **`onLocalCandidate`**: Captures local ICE candidates and emits `localCandidateGenerated`.
    - **`onStateChange`**: Monitors connection state changes, emitting `p2pConnected` and `p2pDisconnected` signals as appropriate.
    - **`onGatheringStateChange`**: Emits `gatheringComplited` when candidate gathering completes.
    - **`onTrack`**: Handles incoming media tracks, binding them to emit the `incommingPacket` signal for incoming data.

#### `void addAudioTrack(const QString& peerId, const QString& trackName)`

- **Description**: Adds an audio track to the specified `PeerConnection` for audio streaming.
- **Code Explanation**:
  - Creates an audio `rtc::Description` with `SendRecv` direction, meaning both sending and receiving capabilities.
  - Registers a callback to capture incoming data messages on the track and emits `incommingPacket` to handle the incoming audio data. Stores the created track in `m_peerTracks`.

---

### SDP Management

#### `void generateOfferSDP(const QString& peerId)`

- **Description**: Generates an SDP offer for initiating a connection with the specified peer.
- **Code Explanation**:
  - Checks if `peerId` exists in `m_peerConnections`; if found, sets the `PeerConnection`’s local description to `Offer` type, beginning the offer phase for establishing a P2P connection.

#### `void generateAnswerSDP(const QString& peerId)`

- **Description**: Generates an SDP answer in response to an offer from the specified peer.
- **Code Explanation**:
  - Verifies that the `peerId` exists, then generates an SDP answer, setting the local description in response to an offer.

#### `void setRemoteDescription(const QString& peerId, const QString& sdp, rtc::Description::Type remoteType)`

- **Description**: Sets the remote SDP description for the specified peer, allowing the P2P connection to use the provided media configuration.
- **Code Explanation**:
  - Locates the `PeerConnection` associated with `peerId`, then applies the remote SDP description, specifying either an offer or answer type.

#### `void setRemoteCandidate(const QString& peerId, const QString& candidate, const QString& sdpMid)`

- **Description**: Adds a remote ICE candidate for the specified peer.
- **Code Explanation**:
  - Adds the `rtc::Candidate` to the peer’s `PeerConnection`, helping establish a robust connection by using network candidate data.

---

### Data Transmission

#### `void sendTrack(const QString& peerId, const QByteArray& buffer)`

- **Description**: Sends audio data to the specified peer by encapsulating it in an RTP packet.
- **Code Explanation**:
  - Constructs an `RtpHeader`, setting fields such as `payloadType`, `sequenceNumber`, `timestamp`, and `ssrc` for tracking the media stream.
  - Appends the RTP header to the `buffer` data, creating an RTP packet that’s sent via the `PeerConnection`’s track.
  - Logs packet transmission details, capturing the size and sending status.

---

### Utility and Helper Functions

#### `QByteArray readVariant(const rtc::message_variant& data)`

- **Description**: Converts an `rtc::message_variant` (string or binary) into a `QByteArray`, handling RTP header removal.
- **Code Explanation**:
  - Uses `std::holds_alternative` to determine the data type (string or binary) and converts it to `QByteArray`.
  - Checks the data size against the RTP header size and removes it if present, yielding clean audio data.

#### `QString descriptionToJson(const rtc::Description& description)`

- **Description**: Converts an SDP description to a JSON string.
- **Code Explanation**:
  - Serializes `rtc::Description` properties into a JSON object with `type` and `sdp` fields, then converts to a compact JSON string format.

---

### Property Management (Getters and Setters)

#### `int bitRate() const`, `void setBitRate(int newBitRate)`, `void resetBitRate()`

- **Description**: Manages the `bitRate` property, with `resetBitRate` setting it to 48,000 bps by default.

#### `int payloadType() const`, `void setPayloadType(int newPayloadType)`, `void resetPayloadType()`

- **Description**: Manages `payloadType`, with `resetPayloadType` defaulting it to 111.

#### `rtc::SSRC ssrc() const`, `void setSsrc(rtc::SSRC newSsrc)`, `void resetSsrc()`

- **Description**: Manages `SSRC`, with `resetSsrc` setting the default value to 2 for tracking audio sources.

#### `bool isOfferer() const`, `void setIsOfferer(bool newIsOfferer)`, `void resetIsOfferer()`

- **Description**: Manages `isOfferer`, with `resetIsOfferer` setting it to `false`, defining whether the instance initiates the WebRTC connection.
